---
title: "R Notebook"
output: html_notebook
---


```{r}
# Create data for increase in number of beds in Winter by individual hospital

beds_winter <- beds %>% 
  filter(str_detect(quarter, "202")) %>% 
  filter(specialty_name == "All Acute") %>% 
  rename(hospital_code = location) %>% 
  select(quarter, hospital_code, average_occupied_beds) %>% 
  mutate(winter = str_detect(quarter, "1$")) %>% 
  group_by(hospital_code, winter) %>% 
  summarise(av_occ = mean(average_occupied_beds)) %>%
  mutate(av_occ = case_when(
    winter == TRUE ~ av_occ,
    winter == FALSE ~ av_occ * -1) 
  ) %>% 
  summarise(winter_beds_increase = sum(av_occ))
```

```{r}
# Create data for increase in deaths in Winter by individual hospital

hospital_deaths_winter <- hospital_deaths %>% 
  filter(str_detect(time_period, "202")) %>% 
  rename(hospital_code = location_code) %>% 
  select(time_period, hospital_code, number_of_deaths) %>% 
  mutate(winter = str_detect(time_period, "1$")) %>% 
  group_by(hospital_code, winter) %>% 
  summarise(av_deaths = mean(number_of_deaths)) %>% 
  mutate(av_deaths = case_when(
    winter == TRUE ~ av_deaths, 
    winter == FALSE ~ av_deaths * -1)
  ) %>% 
  summarise(winter_deaths_increase = sum(av_deaths))
```

```{r}
# Create data for increase in waiting times in Winter by individual hospital

waiting_times_winter <- waiting_times %>% 
  mutate(month = ym(month)) %>% 
  mutate(quarter = quarter(month), .after = month) %>% 
  mutate(target_diff = number_of_attendances_aggregate 
         - number_meeting_target_aggregate, .after = quarter) %>% 
  rename(hospital_code = treatment_location) %>% 
  filter(str_detect(month, "202")) %>% 
  select(month, quarter, hospital_code, target_diff) %>% 
  mutate(winter = quarter == 1) %>% 
  group_by(hospital_code, winter) %>% 
  summarise(av_diff = mean(target_diff)) %>% 
  mutate(
    av_diff = case_when(
      winter == TRUE ~ av_diff,
      winter == FALSE ~ av_diff * -1
    ) 
  ) %>% 
  summarise(winter_target_wait_time_overshoot_increase = sum(av_diff))
```

```{r}
# Joining data to only include hospitals which have corresponding values in each dataset

inner_join(beds_winter, hospital_deaths_winter) %>% 
  inner_join(waiting_times_winter) %>% 
  write_csv(here::here("clean_data/diff_data_hospitals"))
```

